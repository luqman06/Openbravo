<?xml version="1.0"?>
  <database name="TRIGGER OT_VALIDATE_LIMIT_TRG">
    <trigger name="OT_VALIDATE_LIMIT_TRG" table="OT_OVERTIME" fires="after" insert="true" update="true" delete="false" foreach="row">
      <body><![CDATA[
V_OVERTIME_LIMIT NUMBER;
V_OT_HOUR NUMBER;
      
BEGIN
    
    IF AD_isTriggerEnabled()='N' THEN RETURN;
    END IF;

    SELECT AMOUNT INTO V_OVERTIME_LIMIT FROM PYR_SAL_VARIABLE 
    WHERE VALUE='OTLIMIT' AND C_BPARTNER_ID=:NEW.C_BPARTNER_ID
    AND VALIDFROM<=:NEW.DATEFROM
    AND VALIDTO>=:NEW.DATETO
    ORDER BY VALIDFROM DESC LIMIT 1;

	
IF V_OVERTIME_LIMIT IS NULL THEN
	SELECT PARAM_AMOUNT INTO V_OVERTIME_LIMIT
	FROM PYR_EARNING_PARAM WHERE VALUE='OTLIMIT' 
	AND AD_CLIENT_ID=:NEW.AD_CLIENT_ID LIMIT 1;
END IF; 

    SELECT SUM((EXTRACT(HOUR FROM DURATION)*60 + EXTRACT(MINUTE FROM DURATION))/60) INTO V_OT_HOUR
    FROM OT_OVERTIME 
    WHERE C_BPARTNER_ID=:NEW.C_BPARTNER_ID
    AND DATETO<:NEW.DATETO AND CALCULATE='N' AND DOCSTATUS='CO';

    V_OT_HOUR:=coalesce(V_OT_HOUR,0);
    V_OT_HOUR:=V_OT_HOUR+((EXTRACT(HOUR FROM :NEW.DURATION)*60 + EXTRACT(MINUTE FROM :NEW.DURATION))/60);

IF V_OT_HOUR >= V_OVERTIME_LIMIT THEN
 --TODO apa yang akan dilakukan jika lembur lebih dari 54 jam
 --RAISE NO_DATA_FOUND||to_char(V_OT_HOUR*(60*60))::interval;
END IF;	

    END OT_VALIDATE_LIMIT_TRG
]]></body>
    </trigger>
  </database>
